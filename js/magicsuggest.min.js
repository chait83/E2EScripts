(function(b){var a=function(j,r){var d=this;var i={allowFreeEntries:true,allowDuplicates:false,ajaxConfig:{},autoSelect:true,selectFirst:false,queryParam:"query",beforeSend:function(){},cls:"",data:null,dataUrlParams:{},disabled:false,disabledField:null,displayField:"name",editable:true,expanded:false,expandOnFocus:false,groupBy:null,hideTrigger:false,highlight:true,id:null,infoMsgCls:"",inputCfg:{},invalidCls:"ms-inv",matchCase:false,maxDropHeight:290,maxEntryLength:null,maxEntryRenderer:function(s){return"Please reduce your entry by "+s+" character"+(s>1?"s":"")},maxSuggestions:null,maxSelection:10,maxSelectionRenderer:function(s){return"You cannot choose more than "+s+" item"+(s>1?"s":"")},method:"POST",minChars:0,minCharsRenderer:function(s){return"Please type "+s+" more character"+(s>1?"s":"")},mode:"local",name:null,noSuggestionText:"No suggestions",placeholder:"Type or click here",renderer:null,required:false,resultAsString:false,resultAsStringDelimiter:",",resultsField:"results",selectionCls:"",selectionContainer:null,selectionPosition:"inner",selectionRenderer:null,selectionStacked:false,sortDir:"asc",sortOrder:null,strictSuggest:false,style:"",toggleOnClick:false,typeDelay:400,useTabKey:false,useCommaKey:true,useZebraStyle:false,value:null,valueField:"id",vregex:null,vtype:null};var l=b.extend({},r);var k=b.extend(true,{},i,l);this.addToSelection=function(s,u){if(!k.maxSelection||n.length<k.maxSelection){if(!b.isArray(s)){s=[s]}var t=false;b.each(s,function(v,w){if(k.allowDuplicates||b.inArray(w[k.valueField],d.getValue())===-1){n.push(w);t=true}});if(t===true){o._renderSelection();this.empty();if(u!==true){b(this).trigger("selectionchange",[this,this.getSelection()])}}}this.input.attr("placeholder",(k.selectionPosition==="inner"&&this.getValue().length>0)?"":k.placeholder)};this.clear=function(s){this.removeFromSelection(n.slice(0),s)};this.collapse=function(){if(k.expanded===true){this.combobox.detach();k.expanded=false;b(this).trigger("collapse",[this])}};this.disable=function(){this.container.addClass("ms-ctn-disabled");k.disabled=true;d.input.attr("disabled",true)};this.empty=function(){this.input.val("")};this.enable=function(){this.container.removeClass("ms-ctn-disabled");k.disabled=false;d.input.attr("disabled",false)};this.expand=function(){if(!k.expanded&&(this.input.val().length>=k.minChars||this.combobox.children().length>0)){this.combobox.appendTo(this.container);o._processSuggestions();k.expanded=true;b(this).trigger("expand",[this])}};this.isDisabled=function(){return k.disabled};this.isValid=function(){var s=k.required===false||n.length>0;if(k.vtype||k.vregex){b.each(n,function(t,u){s=s&&o._validateSingleItem(u[k.valueField])})}return s};this.getDataUrlParams=function(){return k.dataUrlParams};this.getName=function(){return k.name};this.getSelection=function(){return n};this.getRawValue=function(){return d.input.val()};this.getValue=function(){return b.map(n,function(s){return s[k.valueField]})};this.removeFromSelection=function(s,u){if(!b.isArray(s)){s=[s]}var t=false;b.each(s,function(v,x){var w=b.inArray(x[k.valueField],d.getValue());if(w>-1){n.splice(w,1);t=true}});if(t===true){o._renderSelection();if(u!==true){b(this).trigger("selectionchange",[this,this.getSelection()])}if(k.expandOnFocus){d.expand()}if(k.expanded){o._processSuggestions()}}this.input.attr("placeholder",(k.selectionPosition==="inner"&&this.getValue().length>0)?"":k.placeholder)};this.getData=function(){return e};this.setData=function(s){k.data=s;o._processSuggestions()};this.setName=function(s){k.name=s;if(s){k.name+=s.indexOf("[]")>0?"":"[]"}if(d._valueContainer){b.each(d._valueContainer.children(),function(t,u){u.name=k.name})}};this.setSelection=function(s){this.clear();this.addToSelection(s)};this.setValue=function(t){var s=[];b.each(t,function(u,x){var w=false;b.each(e,function(y,z){if(z[k.valueField]==x){s.push(z);w=true;return false}});if(!w){if(typeof(x)==="object"){s.push(x)}else{var v={};v[k.valueField]=x;v[k.displayField]=x;s.push(v)}}});if(s.length>0){this.addToSelection(s)}};this.setDataUrlParams=function(s){k.dataUrlParams=b.extend({},s)};var n=[],c=0,h,f=false,m=null,e=[],q=false,p={BACKSPACE:8,TAB:9,ENTER:13,CTRL:17,ESC:27,SPACE:32,UPARROW:38,DOWNARROW:40,COMMA:188};var o={_displaySuggestions:function(v){d.combobox.show();d.combobox.empty();var y=0,s=0;if(m===null){o._renderComboItems(v);y=c*v.length}else{for(var u in m){s+=1;b("<div/>",{"class":"ms-res-group",html:u}).appendTo(d.combobox);o._renderComboItems(m[u].items,true)}var x=d.combobox.find(".ms-res-group").outerHeight();if(x!==null){var t=s*x;y=(c*v.length)+t}else{y=c*(v.length+s)}}if(y<d.combobox.height()||y<=k.maxDropHeight){d.combobox.height(y)}else{if(y>=d.combobox.height()&&y>k.maxDropHeight){d.combobox.height(k.maxDropHeight)}}if(v.length===1&&k.autoSelect===true){d.combobox.children().filter(":not(.ms-res-item-disabled):last").addClass("ms-res-item-active")}if(k.selectFirst===true){d.combobox.children().filter(":not(.ms-res-item-disabled):first").addClass("ms-res-item-active")}if(v.length===0&&d.getRawValue()!==""){var w=k.noSuggestionText.replace(/\{\{.*\}\}/,d.input.val());o._updateHelper(w);d.collapse()}if(k.allowFreeEntries===false){if(v.length===0){b(d.input).addClass(k.invalidCls);d.combobox.hide()}else{b(d.input).removeClass(k.invalidCls)}}},_getEntriesFromStringArray:function(t){var s=[];b.each(t,function(u,v){var w={};w[k.displayField]=w[k.valueField]=b.trim(v);s.push(w)});return s},_highlightSuggestion:function(s){var u=d.input.val();var t=["^","$","*","+","?",".","(",")",":","!","|","{","}","[","]"];b.each(t,function(w,x){u=u.replace(x,"\\"+x)});if(u.length===0){return s}var v=k.matchCase===true?"g":"gi";return s.replace(new RegExp("("+u+")(?!([^<]+)?>)",v),"<em>$1</em>")},_moveSelectedRow:function(s){if(!k.expanded){d.expand()}var t,w,u,v;t=d.combobox.find(".ms-res-item:not(.ms-res-item-disabled)");if(s==="down"){w=t.eq(0)}else{w=t.filter(":last")}u=d.combobox.find(".ms-res-item-active:not(.ms-res-item-disabled):first");if(u.length>0){if(s==="down"){w=u.nextAll(".ms-res-item:not(.ms-res-item-disabled)").first();if(w.length===0){w=t.eq(0)}v=d.combobox.scrollTop();d.combobox.scrollTop(0);if(w[0].offsetTop+w.outerHeight()>d.combobox.height()){d.combobox.scrollTop(v+c)}}else{w=u.prevAll(".ms-res-item:not(.ms-res-item-disabled)").first();if(w.length===0){w=t.filter(":last");d.combobox.scrollTop(c*t.length)}if(w[0].offsetTop<d.combobox.scrollTop()){d.combobox.scrollTop(d.combobox.scrollTop()-c)}}}t.removeClass("ms-res-item-active");w.addClass("ms-res-item-active")},_processSuggestions:function(w){var t=null,v=w||k.data;if(v!==null){if(typeof(v)==="function"){v=v.call(d,d.getRawValue())}if(typeof(v)==="string"){b(d).trigger("beforeload",[d]);var u={};u[k.queryParam]=d.input.val();var x=b.extend(u,k.dataUrlParams);b.ajax(b.extend({type:k.method,url:v,data:x,beforeSend:k.beforeSend,success:function(y){t=typeof(y)==="string"?JSON.parse(y):y;o._processSuggestions(t);b(d).trigger("load",[d,t]);if(o._asyncValues){d.setValue(typeof(o._asyncValues)==="string"?JSON.parse(o._asyncValues):o._asyncValues);o._renderSelection();delete (o._asyncValues)}},error:function(){throw ("Could not reach server")}},k.ajaxConfig));return}else{if(v.length>0&&typeof(v[0])==="string"){e=o._getEntriesFromStringArray(v)}else{e=v[k.resultsField]||v}}var s=k.mode==="remote"?e:o._sortAndTrim(e);o._displaySuggestions(o._group(s))}},_render:function(s){d.setName(k.name);d.container=b("<div/>",{"class":"ms-ctn form-control "+(k.resultAsString?"ms-as-string ":"")+k.cls+(b(s).hasClass("input-lg")?" input-lg":"")+(b(s).hasClass("input-sm")?" input-sm":"")+(k.disabled===true?" ms-ctn-disabled":"")+(k.editable===true?"":" ms-ctn-readonly")+(k.hideTrigger===false?"":" ms-no-trigger"),style:k.style,id:k.id});d.container.on("focus",b.proxy(g._onFocus,this));d.container.on("blur",b.proxy(g._onBlur,this));d.container.on("keydown",b.proxy(g._onKeyDown,this));d.container.on("keyup",b.proxy(g._onKeyUp,this));d.input=b("<input/>",b.extend({type:"text","class":k.editable===true?"":" ms-input-readonly",readonly:!k.editable,placeholder:k.placeholder,disabled:k.disabled},k.inputCfg));d.input.on("focus",b.proxy(g._onInputFocus,this));d.input.on("click",b.proxy(g._onInputClick,this));d.combobox=b("<div/>",{"class":"ms-res-ctn dropdown-menu"}).height(k.maxDropHeight);d.combobox.on("click","div.ms-res-item",b.proxy(g._onComboItemSelected,this));d.combobox.on("mouseover","div.ms-res-item",b.proxy(g._onComboItemMouseOver,this));if(k.selectionContainer){d.selectionContainer=k.selectionContainer;b(d.selectionContainer).addClass("ms-sel-ctn")}else{d.selectionContainer=b("<div/>",{"class":"ms-sel-ctn"})}d.selectionContainer.on("click",b.proxy(g._onFocus,this));if(k.selectionPosition==="inner"&&!k.selectionContainer){d.selectionContainer.append(d.input)}else{d.container.append(d.input)}d.helper=b("<span/>",{"class":"ms-helper "+k.infoMsgCls});o._updateHelper();d.container.append(d.helper);b(s).replaceWith(d.container);if(!k.selectionContainer){switch(k.selectionPosition){case"bottom":d.selectionContainer.insertAfter(d.container);if(k.selectionStacked===true){d.selectionContainer.width(d.container.width());d.selectionContainer.addClass("ms-stacked")}break;case"right":d.selectionContainer.insertAfter(d.container);d.container.css("float","left");break;default:d.container.append(d.selectionContainer);break}}if(k.hideTrigger===false){d.trigger=b("<div/>",{"class":"ms-trigger",html:'<div class="ms-trigger-ico"></div>'});d.trigger.on("click",b.proxy(g._onTriggerClick,this));d.container.append(d.trigger)}b(window).on("resize",b.proxy(g._onWindowResized,this));if(k.value!==null||k.data!==null){if(typeof(k.data)==="string"){o._asyncValues=k.value;o._processSuggestions()}else{o._processSuggestions();if(k.value!==null){d.setValue(k.value);o._renderSelection()}}}b("body").on("click",function(t){if(d.container.hasClass("ms-ctn-focus")&&d.container.has(t.target).length===0&&t.target.className.indexOf("ms-res-item")<0&&t.target.className.indexOf("ms-close-btn")<0&&d.container[0]!==t.target){g._onBlur()}});if(k.expanded===true){k.expanded=false;d.expand()}},_renderComboItems:function(s,v){var u=this,t="";b.each(s,function(w,z){var y=k.renderer!==null?k.renderer.call(u,z):z[k.displayField];var x=k.disabledField!==null&&z[k.disabledField]===true;var A=b("<div/>",{"class":"ms-res-item "+(v?"ms-res-item-grouped ":"")+(x?"ms-res-item-disabled ":"")+(w%2===1&&k.useZebraStyle===true?"ms-res-odd":""),html:k.highlight===true?o._highlightSuggestion(y):y,"data-json":JSON.stringify(z)});t+=b("<div/>").append(A).html()});d.combobox.append(t);c=d.combobox.find(".ms-res-item:first").outerHeight()},_renderSelection:function(){var v=this,s=0,u=0,t=[],x=k.resultAsString===true&&!f;d.selectionContainer.find(".ms-sel-item").remove();if(d._valueContainer!==undefined){d._valueContainer.remove()}b.each(n,function(A,C){var B,z,y=k.selectionRenderer!==null?k.selectionRenderer.call(v,C):C[k.displayField];var w=o._validateSingleItem(C[k.displayField])?"":" ms-sel-invalid";if(x===true){B=b("<div/>",{"class":"ms-sel-item ms-sel-text "+k.selectionCls+w,html:y+(A===(n.length-1)?"":k.resultAsStringDelimiter)}).data("json",C)}else{B=b("<div/>",{"class":"ms-sel-item "+k.selectionCls+w,html:y}).data("json",C);if(k.disabled===false){z=b("<span/>",{"class":"ms-close-btn"}).data("json",C).appendTo(B);z.on("click",b.proxy(g._onTagTriggerClick,v))}}t.push(B)});d.selectionContainer.prepend(t);d._valueContainer=b("<div/>",{style:"display: none;"});b.each(d.getValue(),function(w,z){var y=b("<input/>",{type:"hidden",name:k.name,value:z});y.appendTo(d._valueContainer)});d._valueContainer.appendTo(d.selectionContainer);if(k.selectionPosition==="inner"&&!k.selectionContainer){d.input.width(0);u=d.input.offset().left-d.selectionContainer.offset().left;s=d.container.width()-u-42;d.input.width(s)}if(n.length===k.maxSelection){o._updateHelper(k.maxSelectionRenderer.call(this,n.length))}else{d.helper.hide()}},_selectItem:function(s){if(k.maxSelection===1){n=[]}d.addToSelection(s.data("json"));s.removeClass("ms-res-item-active");if(k.expandOnFocus===false||n.length===k.maxSelection){d.collapse()}if(!f){d.input.trigger("focus")}else{if(f&&(k.expandOnFocus||q)){o._processSuggestions();if(q){d.expand()}}}},_sortAndTrim:function(v){var u=d.getRawValue(),t=[],w=[],s=d.getValue();if(u.length>0){b.each(v,function(y,z){var x=z[k.displayField];if((k.matchCase===true&&x.indexOf(u)>-1)||(k.matchCase===false&&x.toLowerCase().indexOf(u.toLowerCase())>-1)){if(k.strictSuggest===false||x.toLowerCase().indexOf(u.toLowerCase())===0){t.push(z)}}})}else{t=v}b.each(t,function(x,y){if(k.allowDuplicates||b.inArray(y[k.valueField],s)===-1){w.push(y)}});if(k.sortOrder!==null){w.sort(function(y,x){if(y[k.sortOrder]<x[k.sortOrder]){return k.sortDir==="asc"?-1:1}if(y[k.sortOrder]>x[k.sortOrder]){return k.sortDir==="asc"?1:-1}return 0})}if(k.maxSuggestions&&k.maxSuggestions>0){w=w.slice(0,k.maxSuggestions)}return w},_group:function(s){if(k.groupBy!==null){m={};b.each(s,function(t,v){var u=k.groupBy.indexOf(".")>-1?k.groupBy.split("."):k.groupBy;var w=v[k.groupBy];if(typeof(u)!="string"){w=v;while(u.length>0){w=w[u.shift()]}}if(m[w]===undefined){m[w]={title:w,items:[v]}}else{m[w].items.push(v)}})}return s},_updateHelper:function(s){d.helper.html(s);if(!d.helper.is(":visible")){d.helper.fadeIn()}},_validateSingleItem:function(s){if(k.vregex!==null&&k.vregex instanceof RegExp){return k.vregex.test(s)}else{if(k.vtype!==null){switch(k.vtype){case"alpha":return(/^[a-zA-Z_]+$/).test(s);case"alphanum":return(/^[a-zA-Z0-9_]+$/).test(s);case"email":return(/^(\w+)([\-+.][\w]+)*@(\w[\-\w]*\.){1,5}([A-Za-z]){2,6}$/).test(s);case"url":return(/(((^https?)|(^ftp)):\/\/([\-\w]+\.)+\w{2,3}(\/[%\-\w]+(\.\w{2,})?)*(([\w\-\.\?\\\/+@&#;`~=%!]*)(\.\w{2,})?)*\/?)/i).test(s);case"ipaddress":return(/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/).test(s)}}}return true}};var g={_onBlur:function(){d.container.removeClass("ms-ctn-focus");d.collapse();f=false;if(d.getRawValue()!==""&&k.allowFreeEntries===true){var s={};s[k.displayField]=s[k.valueField]=b.trim(d.getRawValue());d.addToSelection(s)}o._renderSelection();if(d.isValid()===false){d.container.addClass(k.invalidCls)}else{if(d.input.val()!==""&&k.allowFreeEntries===false){d.empty();o._updateHelper("")}}b(d).trigger("blur",[d])},_onComboItemMouseOver:function(t){var s=b(t.currentTarget);if(!s.hasClass("ms-res-item-disabled")){d.combobox.children().removeClass("ms-res-item-active");s.addClass("ms-res-item-active")}},_onComboItemSelected:function(t){var s=b(t.currentTarget);if(!s.hasClass("ms-res-item-disabled")){o._selectItem(b(t.currentTarget))}},_onFocus:function(){d.input.trigger("focus")},_onInputClick:function(){if(d.isDisabled()===false&&f){if(k.toggleOnClick===true){if(k.expanded){d.collapse()}else{d.expand()}}}},_onInputFocus:function(){if(d.isDisabled()===false&&!f){f=true;d.container.addClass("ms-ctn-focus");d.container.removeClass(k.invalidCls);var s=d.getRawValue().length;if(k.expandOnFocus===true){d.expand()}if(n.length===k.maxSelection){o._updateHelper(k.maxSelectionRenderer.call(this,n.length))}else{if(s<k.minChars){o._updateHelper(k.minCharsRenderer.call(this,k.minChars-s))}}o._renderSelection();b(d).trigger("focus",[d])}},_onKeyDown:function(u){var t=d.combobox.find(".ms-res-item-active:not(.ms-res-item-disabled):first"),s=d.input.val();b(d).trigger("keydown",[d,u]);if(u.keyCode===p.TAB&&(k.useTabKey===false||(k.useTabKey===true&&t.length===0&&d.input.val().length===0))){g._onBlur();return}switch(u.keyCode){case p.BACKSPACE:if(s.length===0&&d.getSelection().length>0&&k.selectionPosition==="inner"){n.pop();o._renderSelection();b(d).trigger("selectionchange",[d,d.getSelection()]);d.input.attr("placeholder",(k.selectionPosition==="inner"&&d.getValue().length>0)?"":k.placeholder);d.input.trigger("focus");u.preventDefault()}break;case p.TAB:case p.ESC:u.preventDefault();break;case p.ENTER:if(s!==""||k.expanded){u.preventDefault()}break;case p.COMMA:if(k.useCommaKey===true){u.preventDefault()}break;case p.CTRL:q=true;break;case p.DOWNARROW:u.preventDefault();o._moveSelectedRow("down");break;case p.UPARROW:u.preventDefault();o._moveSelectedRow("up");break;default:if(n.length===k.maxSelection){u.preventDefault()}break}},_onKeyUp:function(v){var s=d.getRawValue(),w=b.trim(d.input.val()).length>0&&(!k.maxEntryLength||b.trim(d.input.val()).length<=k.maxEntryLength),t,u={};b(d).trigger("keyup",[d,v]);clearTimeout(h);if(v.keyCode===p.ESC&&k.expanded){d.combobox.hide()}if((v.keyCode===p.TAB&&k.useTabKey===false)||(v.keyCode>p.ENTER&&v.keyCode<p.SPACE)){if(v.keyCode===p.CTRL){q=false}return}switch(v.keyCode){case p.UPARROW:case p.DOWNARROW:v.preventDefault();break;case p.ENTER:case p.TAB:case p.COMMA:if(v.keyCode!==p.COMMA||k.useCommaKey===true){v.preventDefault();if(k.expanded===true){t=d.combobox.find(".ms-res-item-active:not(.ms-res-item-disabled):first");if(t.length>0){o._selectItem(t);return}}if(w===true&&k.allowFreeEntries===true){u[k.displayField]=u[k.valueField]=b.trim(s);d.addToSelection(u);d.collapse();d.input.trigger("focus")}break}default:if(n.length===k.maxSelection){o._updateHelper(k.maxSelectionRenderer.call(this,n.length))}else{if(s.length<k.minChars){o._updateHelper(k.minCharsRenderer.call(this,k.minChars-s.length));if(k.expanded===true){d.collapse()}}else{if(k.maxEntryLength&&s.length>k.maxEntryLength){o._updateHelper(k.maxEntryRenderer.call(this,s.length-k.maxEntryLength));if(k.expanded===true){d.collapse()}}else{d.helper.hide();if(k.minChars<=s.length){h=setTimeout(function(){if(k.expanded===true){o._processSuggestions()}else{d.expand()}},k.typeDelay)}}}}break}},_onTagTriggerClick:function(s){d.removeFromSelection(b(s.currentTarget).data("json"))},_onTriggerClick:function(){if(d.isDisabled()===false&&!(k.expandOnFocus===true&&n.length===k.maxSelection)){b(d).trigger("triggerclick",[d]);if(k.expanded===true){d.collapse()}else{var s=d.getRawValue().length;if(s>=k.minChars){d.input.trigger("focus");d.expand()}else{o._updateHelper(k.minCharsRenderer.call(this,k.minChars-s))}}}},_onWindowResized:function(){o._renderSelection()}};if(j!==null){o._render(j)}};b.fn.magicSuggest=function(c){var d=b(this);if(d.length===1&&d.data("magicSuggest")){return d.data("magicSuggest")}d.each(function(e){var g=b(this);if(g.data("magicSuggest")){return}if(this.nodeName.toLowerCase()==="select"){c.data=[];c.value=[];b.each(this.children,function(i,j){if(j.nodeName&&j.nodeName.toLowerCase()==="option"){c.data.push({id:j.value,name:j.text});if(b(j).attr("selected")){c.value.push(j.value)}}})}var f={};b.each(this.attributes,function(k,j){f[j.name]=j.name==="value"&&j.value!==""?JSON.parse(j.value):j.value});var h=new a(this,b.extend([],b.fn.magicSuggest.defaults,c,f));g.data("magicSuggest",h);h.container.data("magicSuggest",h)});if(d.length===1){return d.data("magicSuggest")}return d};b.fn.magicSuggest.defaults={}})(jQuery);